<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../tf-backend/tf-backend.html">
<link rel="import" href="../tf-card-heading/tf-card-heading.html">
<link rel="import" href="../tf-color-scale/tf-color-scale.html">
<link rel="import" href="../tf-imports/lodash.html">


<dom-module id="arrays-card">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        width: 330px;
        height: 235px;
        margin-right: 10px;
        margin-bottom: 15px;
      }
      :host[_expanded] {
        width: 700px;
        height: 500px;
      }
    </style>
    <tf-card-heading title="[[tag]]" color="[[_runColor]]">
      [[run]]
    </tf-card-heading>
    <div>
      Array Display [[step]]
    </div>
    <div>
      <paper-slider
        pin
        id="slider"
        min="0"
        max="100"
        type="number"
        value="{{step}}"
      ></paper-slider>
      <paper-input
        label="Rows"
        always-float-label
        placeholder="e.g. :4, 5:7, -2:"
        auto-validate pattern="[a-zA-Z]*"
        error-message="invalid format"
      ></paper-input>

    </div>
  </template>
  <script>
    "use strict";

    Polymer({
      is: "arrays-card",
      properties: {
        run: String,
        tag: String,

        /** @type {Function} */
        _colorScaleFunction: {
          type: Object,  // function: string => string
          value: () => tf_color_scale.runsColorScale,
        },
        _runColor: {
          type: String,
          computed: "_computeRunColor(run)",
        },
        requestManager: Object,
        _canceller: {
          type: Object,
          value: () => new tf_backend.Canceller(),
        },
      },

      observers: ["_fetchNewData(run, tag)"],

      _computeRunColor(run) {
        return this._colorScaleFunction(run);
      },
      attached() {
        // Defer reloading until after we're attached, because that ensures that
        // the requestManager has been set from above. (Polymer is tricky
        // sometimes)
        this._attached = true;
        this.reload();
      },
      reload() {
        this._fetchNewData(this.run, this.tag);
      },
      _fetchNewData(run, tag) {
        if (!this._attached) {
          return;
        }
        this._canceller.cancelAll();
        const url = tf_backend.addParams(
          tf_backend.getRouter().pluginRoute('arrays', '/arrays'),
          {tag, run}
        );
        const updateData = this._canceller.cancellable(result => {
          if (result.cancelled) {
            return;
          }
          const backendData = result.value;
          this.arrays = backendData;
        });
        this.requestManager.request(url).then(updateData);
      },
    });
  </script>
</dom-module>
