<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../tf-backend/tf-backend.html">
<link rel="import" href="../../tf-card-heading/tf-card-heading.html">
<link rel="import" href="../../tf-color-scale/tf-color-scale.html">
<link rel="import" href="../../tf-imports/lodash.html">
<link rel="import" href="vz-rectangle-plot.html">


<dom-module id="arrays-card">
  <template>
    <tf-card-heading title="[[tag]]" run="[[run]]" color="[[_runColor]]">
    </tf-card-heading>
    <div id="rectangle-plot-container">
      <vz-rectangle-plot data="[[this.array]]"></vz-rectangle-plot>
    </div>
    <div id="options">
      <div id="step-label">Step</div>
      <paper-slider
        pin
        id="slider"
        label="Step"
        min="0"
        max="100"
        type="number"
        value="{{step}}"
      ></paper-slider>
      <paper-input
        label="Rows"
        always-float-label
        placeholder="e.g. 0, 1, 2"
        auto-validate pattern="^[0-9]+(,\s?[0-9]+)*$"
        error-message="invalid format"
      ></paper-input>
      <div style="width: 20px"></div>
      <paper-input
        label="Columns"
        always-float-label
        placeholder="e.g. 0, 1, 2"
        auto-validate pattern="^[0-9]+(,\s?[0-9]+)*$"
        error-message="invalid format"
      ></paper-input>
    </div>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 235px;
        margin-right: 10px;
        margin-bottom: 15px;
      }

      :host[_expanded] {
        width: 100%;
        height: 500px;
      }

      #options {
        display: flex;
        flex-direction: row;
      }

      #step-label {
        display: flex;
        justify-content: center;
        flex-direction: column;
        font-size: 14px;
      }

      paper-slider {
        flex-grow: 5;
      }

      paper-input {
        font-size: 14px;
      }
    </style>
  </template>
  <script>
    "use strict";

    Polymer({
      is: "arrays-card",

      properties: {
        run: String,
        tag: String,
        /** @type {Function} */
        _colorScaleFunction: {
          type: Object,  // function: string => string
          value: () => tf_color_scale.runsColorScale,
        },
        _runColor: {
          type: String,
          computed: "_computeRunColor(run)",
        },
        requestManager: Object,
        _canceller: {
          type: Object,
          value: () => new tf_backend.Canceller(),
        },
      },

      observers: ["_fetchNewData(run, tag)"],

      attached() {
        // Defer reloading until after we're attached, because that ensures that
        // the requestManager has been set from above. (Polymer is tricky
        // sometimes)
        this._attached = true;
        this.reload();
      },

      reload() {
        this._fetchNewData(this.run, this.tag);
      },

      _fetchNewData(run, tag) {
        if (!this._attached) {
          return;
        }
        this._canceller.cancelAll();
        const url = tf_backend.addParams(
          tf_backend.getRouter().pluginRoute('arrays', '/arrays'),
          {tag, run}
        );
        const updateData = this._canceller.cancellable(result => {
          if (result.cancelled) {
            return;
          }
          const backendData = result.value;
          this.array = backendData;
        });
        this.requestManager.request(url).then(updateData);
      },

      _computeRunColor(run) {
        return this._colorScaleFunction(run);
      },
    });
  </script>
</dom-module>
