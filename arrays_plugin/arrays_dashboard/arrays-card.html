<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../tf-backend/tf-backend.html">
<link rel="import" href="../../tf-card-heading/tf-card-heading.html">
<link rel="import" href="../../tf-color-scale/tf-color-scale.html">
<link rel="import" href="../../tf-imports/lodash.html">
<link rel="import" href="../../tf-imports/plottable.html">
<link rel="import" href="vz-rectangle-plot.html">


<dom-module id="arrays-card">
  <template>
    <tf-card-heading
      title="[[tag]]"
      run="[[run]]"
      color="[[_runColor]]"
    ></tf-card-heading>
    <vz-rectangle-plot
      data="[[_arrayData]]"
      color="[[_runColor]]"
    ></vz-rectangle-plot>
    <div id="options">
      <div id="step-label">Step</div>
      <paper-slider
        pin
        id="slider"
        label="Step"
        type="number"
        min="{{minStep}}"
        max="{{maxStep}}"
        value="{{step}}"
        on-change="_updateArray"
      ></paper-slider>
      <paper-input
        label="Rows"
        always-float-label
        placeholder="e.g. 0, 1, 2"
        auto-validate pattern="^[0-9]+(,\s?[0-9]+)*$"
        error-message="invalid format"
      ></paper-input>
      <div style="width: 20px"></div>
      <paper-input
        label="Columns"
        always-float-label
        placeholder="e.g. 0, 1, 2"
        auto-validate pattern="^[0-9]+(,\s?[0-9]+)*$"
        error-message="invalid format"
      ></paper-input>
    </div>
    <style>
      :host {
        margin: 5px;
        display: block;
        width: 480px;
        --color: #000000;
      }

      /* :host[_expanded] {
        width: 100%;
      } */

      tf-card-heading {
        display: block;
        margin-bottom: 10px;
      }

      vz-rectangle-plot {
        height: 360px;
        width: 100%;
      }

      #options {
        display: flex;
        flex-direction: row;
      }

      #step-label {
        display: flex;
        justify-content: center;
        flex-direction: column;
        font-size: 14px;
      }

      #options paper-slider {
        width: 360px;
        flex-grow: 3;
        --paper-slider-active-color: var(--color);
        --paper-slider-knob-color: var(--color);
        --paper-slider-knob-start-border-color: var(--color);
        --paper-slider-knob-start-color: var(--color);
        --paper-slider-markers-color: var(--color);
        --paper-slider-pin-color: var(--color);
        --paper-slider-pin-start-color: var(--color);
      }

      #options paper-input {
        --paper-input-container-focus-color: var(--color);
      }

      paper-input {
        font-size: 14px;
      }
    </style>
  </template>
  <script>
    "use strict";

    Polymer({
      is: "arrays-card",

      properties: {
        run: String,
        tag: String,
        step: Number,
        minStep: {
          type: Number,
          value: 0,
        },
        maxStep: {
          type: Number,
          value: 10,
        },
        _data: Object,
        _arrayData: Object,
        _colorScaleFunction: {
          type: Object,  // function: string => string
          value: () => tf_color_scale.runsColorScale,
        },
        _runColor: {
          type: String,
          computed: "_computeRunColor(run)",
        },
        requestManager: Object,
        _canceller: {
          type: Object,
          value: () => new tf_backend.Canceller(),
        },
      },

      observers: ["_fetchNewData(run, tag)"],

      ready() {
        this._updateColors(this._runColor);
      },

      attached() {
        // Defer reloading until after we're attached, because that ensures that
        // the requestManager has been set from above. (Polymer is tricky
        // sometimes)
        this._attached = true;
        this.reload();
      },

      reload() {
        this._updateColors(this._runColor);
        this._fetchNewData(this.run, this.tag);
      },

      _fetchNewData(run, tag) {
        if (!this._attached) {
          return;
        }
        this._canceller.cancelAll();
        const url = tf_backend.addParams(
          tf_backend.getRouter().pluginRoute('arrays', '/arrays'),
          {tag, run}
        );
        const updateData = this._canceller.cancellable(result => {
          if (result.cancelled) {
            return;
          }
          const backendData = result.value;
          // Compute min and max step values
          let minStep = Number.POSITIVE_INFINITY;
          let maxStep = Number.NEGATIVE_INFINITY;
          for (const d of backendData) {
            if (d.step < minStep) minStep = d.step;
            if (d.step > maxStep) maxStep = d.step;
          }
          // this.minStep = minStep;
          this.maxStep = maxStep;
          this._data = backendData;
          this._updateArray();
        });
        this.requestManager.request(url).then(updateData);
      },

      _updateArray() {
        let array;
        for (const d of this._data) {
          if (d.step == this.step) array = d.array;
        }

        const arrayData = [];
        for (let i = 0; i < array.length; i++) {
          for (let j = 0; j < array[0].length; j++) {
            arrayData.push({"x": i, "y": j, "val": array[i][j]});
          }
        }

        if (arrayData) {
          this._arrayData = arrayData;
        }
      },

      _updateColors(runColor) {
        this.customStyle['--color'] = runColor;
        this.updateStyles();
      },

      _computeRunColor(run) {
        return this._colorScaleFunction(run);
      },
    });
  </script>
</dom-module>
